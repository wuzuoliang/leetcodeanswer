# 二叉堆：动态维护集合最值的利器
https://time.geekbang.org/column/article/275747

## 理解完全二叉树基础
既然要讲堆这种结构，就离不开一种特殊的二叉树，也就是完全二叉树（Complete Binary Tree）。因为堆就是一种具有特殊性质的完全二叉树。什么是完全二叉树呢？完全二叉树是由满二叉树去掉最后一层右侧的若干节点而形成的二叉树结构。
![图1](https://static001.geekbang.org/resource/image/be/f2/be70f37ca4ab58fbdcf3d01dd1b5c3f2.jpg)
完全二叉树有一个很优秀的性质，就是可以被存储在一片连续的数组空间中。这怎么理解呢？还是看上面这个示意图，如果我们对它的每个节点进行编号，采用从上到下、从左到右的顺序依次标上 1 到 6。那么你仔细观察其中父节点编号与子节点编号之间的关系就会发现，如果父节点编号是 i，其左孩子的编号就是 2 * i，右孩子的编号就是 2 * i + 1。例如，我们以 3 号节点作为父节点，其左孩子的编号就是 2 * 3 = 6 号，如果有右孩子，那它右孩子的编号就一定是 2 * 3 + 1 = 7。我们再继续深入思考，在一棵有 n 个节点的完全二叉树中，节点编号应该为 1 到 n。这样，我们就可以使用数组的 1 到 n 位对应于这 n 个节点。由于完全二叉树父节点与子节点编号之间的特殊计算关系，因此只要我们知道父节点编号，就可以通过计算得到子节点编号。这就意味着，即使我们将完全二叉树的所有数据，存储在一个连续的数组空间中，也不会破坏其特殊的树形结构信息。也就是说，一棵完全二叉树可以对应到一段连续的数组空间，而根据数组空间的内容，我们也可以唯一地还原成一棵完全二叉树。

## 堆结构定义
如果在一棵完全二叉树中，每个父节点的值都要小于其两个子节点的值，我们就管这种结构叫做小顶堆。相对应地，大顶堆就是每个父节点的值要大于其两个子节点的值。

### 堆的插入操作
假设我们想要在堆中放入一个新的元素 1，那么我们可以将这个新的元素，放置到整个数组的最后一位。对应到完全二叉树的思维逻辑结构中，就是向树中的最后一层添加了一个新的叶节点。
![图2](https://static001.geekbang.org/resource/image/0d/ee/0de0a63918eabaea63846eab343b62ee.jpg)
这一步的操作叫做元素放置。你会看到这么做之后，数组的结构就不满足小顶堆的性质了。所以下一步，我们要调整数组的结构，让它依然满足堆的性质。
结合上面的示意图，我来说一下具体的操作。由于 1 比 4 小，所以我们把 1 交换到 4 的位置，然后让 1 再继续向上跟当前的父节点比较。因为 1 比 2 小，所以再让它们交换。这一步叫做向上调整，它的原理就是在当前元素值小于其父节点值的时候，交换子节点与父节点值的位置，就这样一直向上调整，直到当前节点大于父节点的值或者调整到了堆顶。

### 堆的删除最值操作
首先，我们要知道，堆的删除操作是有局限性的，这怎么理解呢？我们可以从删除操作的定义入手。堆的删除操作也叫做删除最值元素，对小顶堆进行删除操作就是删除最小的元素，其实就是删除数组中第一位的元素。那为了保证删除最值元素以后，整个堆结构的存储还是从数组的第 1 位开始的，所以我们第一步要做的就是元素覆盖，也就是用堆的最后一位元素，覆盖掉堆顶元素。
![p](https://static001.geekbang.org/resource/image/1b/b5/1bc73192812611ceefd3bf2f2c1709b5.jpg)
这里呢，我们就接着前面插入元素后的结果，来继续删除元素。从上图中你可以看到，我们使用数组中的最后一个元素 4，覆盖了堆顶元素 1。接下来，我们就需要通过适当调整，让它重新满足堆的性质。调整的方法其实也很简单，就是从堆顶位置开始，每次从当前元素所在三元组中找到一个最小值，与当前元素交换。交换后，让当前位置的元素继续和下面两个元素比较，如果这个三元组中依然有最小值，那我们就继续向下调整，直到当前元素是三元组中的最小值为止。
